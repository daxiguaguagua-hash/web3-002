name: Build & Deploy MintLedger (Docker)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»ºé•œåƒï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰'
        required: false
        default: 'false'
        type: boolean

env:
  IMAGE_NAME: mintledger
  CONTAINER_NAME: mintledger-app
  HOST_PORT: 80
  CONTAINER_PORT: 80

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: æ„å»º Docker é•œåƒå¹¶æ¨é€åˆ° GHCR
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: ğŸ”¨ Build Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ç”Ÿæˆä¸¤ä¸ª tagï¼šlatest + git short sha
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix=,format=short

      # æ„å»ºå¹¶æ¨é€
      # node:22-alpine æ»¡è¶³ @vitejs/plugin-react@5.1.4 çš„ engine è¦æ±‚
      # pnpm@9 ä¸ pnpm-lock.yaml lockfileVersion 9.0 ä¸¥æ ¼å¯¹åº”
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          no-cache: ${{ inputs.force_rebuild == 'true' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VITE_APP_MODE=prod
            VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}
          platforms: linux/amd64

      - name: Summary
        run: |
          echo "### ğŸ³ é•œåƒæ„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:** \`${{ steps.meta.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: SSH åˆ° EC2ï¼Œæ‹‰å–é•œåƒå¹¶æ»šåŠ¨é‡å¯å®¹å™¨
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: ğŸš€ Deploy to EC2
    runs-on: ubuntu-latest
    needs: build
    environment: production

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          IMAGE_FULL: ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
          CONTAINER_NAME: ${{ env.CONTAINER_NAME }}
          HOST_PORT: ${{ env.HOST_PORT }}
          CONTAINER_PORT: ${{ env.CONTAINER_PORT }}
          GIT_SHA: ${{ github.sha }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          envs: GHCR_TOKEN,GITHUB_ACTOR,IMAGE_FULL,CONTAINER_NAME,HOST_PORT,CONTAINER_PORT,GIT_SHA
          script: |
            set -e

            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  MintLedger Deploy"
            echo "  Commit: ${GIT_SHA:0:7}"
            echo "  Time:   $(date)"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            # â”€â”€ 1. ç™»å½• GHCR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin

            # â”€â”€ 2. æ‹‰å–æœ€æ–°é•œåƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "â–¶ æ‹‰å–é•œåƒ: $IMAGE_FULL"
            docker pull "$IMAGE_FULL"

            # â”€â”€ 3. åœæ‰æ‰€æœ‰å ç”¨ç«¯å£çš„æ—§å®¹å™¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "â–¶ åœæ­¢å ç”¨ ${HOST_PORT} ç«¯å£çš„æ—§å®¹å™¨..."
            OLD_CONTAINERS=$(docker ps -q --filter "publish=${HOST_PORT}" || true)
            if [ -n "$OLD_CONTAINERS" ]; then
              docker stop $OLD_CONTAINERS && docker rm $OLD_CONTAINERS
              echo "  å·²åœæ­¢æ—§å®¹å™¨"
            else
              echo "  æ— æ—§å®¹å™¨"
            fi

            # â”€â”€ 4. å¯åŠ¨æ–°å®¹å™¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            NEW="${CONTAINER_NAME}-${GIT_SHA:0:7}"
            echo "â–¶ å¯åŠ¨æ–°å®¹å™¨: $NEW"
            docker run -d \
              --name "$NEW" \
              --restart unless-stopped \
              -p "${HOST_PORT}:${CONTAINER_PORT}" \
              --health-cmd="curl -fs http://localhost/healthz || exit 1" \
              --health-interval=5s \
              --health-timeout=3s \
              --health-retries=5 \
              --health-start-period=30s \
              "$IMAGE_FULL"

            # â”€â”€ 5. ç­‰å¾…å¥åº·æ£€æŸ¥é€šè¿‡ï¼ˆæœ€å¤š 120sï¼‰â”€â”€â”€â”€â”€â”€
            echo "â–¶ ç­‰å¾…å¥åº·æ£€æŸ¥..."
            SECONDS=0
            until [ "$(docker inspect --format='{{.State.Health.Status}}' "$NEW")" = "healthy" ]; do
              if [ $SECONDS -ge 120 ]; then
                echo "âŒ å¥åº·æ£€æŸ¥è¶…æ—¶ï¼Œå›æ»š"
                docker stop "$NEW" && docker rm "$NEW"
                exit 1
              fi
              echo "  ç­‰å¾…ä¸­... ${SECONDS}s / 120s"
              sleep 3
            done
            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œè€—æ—¶ ${SECONDS}s"

            # é‡å‘½åä¸ºæ ‡å‡†å®¹å™¨åï¼Œæ–¹ä¾¿åç»­æ—¥å¿—æŸ¥çœ‹
            docker rename "$NEW" "$CONTAINER_NAME" 2>/dev/null || true

            # â”€â”€ 6. æ¸…ç†æ‚¬ç©ºé•œåƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            docker image prune -f

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  âœ… éƒ¨ç½²æˆåŠŸï¼"
            docker ps --filter "name=${CONTAINER_NAME}" \
              --format "  å®¹å™¨: {{.Names}} | {{.Status}}"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: éƒ¨ç½²å¤±è´¥æ—¶è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ä¸ªé•œåƒ
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  rollback-on-failure:
    name: âª Auto Rollback
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: failure() && needs.deploy.result == 'failure'

    steps:
      - name: Rollback to previous image
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          script: |
            echo "âª å¼€å§‹å›æ»š..."
            PREV=$(docker images \
              "ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}" \
              --format "{{.Repository}}:{{.Tag}}" \
              | grep -v latest | sed -n '2p')

            if [ -n "$PREV" ]; then
              docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
              docker rm   ${{ env.CONTAINER_NAME }} 2>/dev/null || true
              docker run -d \
                --name ${{ env.CONTAINER_NAME }} \
                --restart unless-stopped \
                -p ${{ env.HOST_PORT }}:${{ env.CONTAINER_PORT }} \
                "$PREV"
              echo "âœ… å·²å›æ»šåˆ°: $PREV"
            else
              echo "âŒ æœªæ‰¾åˆ°å†å²é•œåƒï¼Œæ— æ³•è‡ªåŠ¨å›æ»š"
              exit 1
            fi
