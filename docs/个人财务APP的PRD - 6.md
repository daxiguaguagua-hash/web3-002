# 极简风格家庭/个人财务记账APP — PRD（v1.4 最终锁定版）

版本：v1.4（最终锁定：汇率弹窗模态、隐私账本完全禁止导出分享、离线验证首选mock时钟）
负责人：Product
平台：iOS / Android（MVP）；Web（仅展示/演示）

---

## 1. 产品定义

### 1.1 产品定位

移动优先、极简交互、支持家庭共享与个人隐私并存的多账户多币种记账App，主打“5秒一笔、预算可控、统计清晰、离线可靠”。

### 1.2 成功指标（可测试口径）

- **5秒一笔（P95≤5秒）**：标准设备上，从点击“+”打开记账面板到点击“保存”且列表出现新记录。
  - 标准设备：iPhone 12 / iOS 15+；Android 11+（骁龙778G级）
  - 计入：渲染、键盘弹起、本地写入、列表刷新；不计入云同步耗时
- **离线可靠（7×24小时）**：从离线创建数据的时刻起计算，在不联网、不卸载、不清除数据、不重置系统时间情况下，至少 **7×24小时** 可见且不丢失。
- **统计准确**：流水为唯一事实来源；统计误差为0（仅显示舍入差异）
- **预算可控**：保存后1秒内进度刷新；阈值提醒去重：同周期同阈值每用户最多1次/天

---

## 2. Non-Goals（边界）

- 不做投资理财资产管理
- 不做银行自动同步/开放银行
- 不做Web端真实记账/真实登录/真实同步（Web仅演示，不接真实用户数据）

---

## 3. 关键体验与异常定义

### 3.1 关键路径（5秒记账）

首页 → “+” → 输入金额 → 类别默认/选择 → 保存 → 列表出现新记录

### 3.2 异常定义（允许额外提示/点击的唯一场景）

- 必填缺失：金额为空/≤0、账户/类别/账本为空
- 输入非法：金额非法字符、超上限
- 权限不足：编辑/删除他人流水
- 隐私解锁失败：生物识别失败触发PIN
- 汇率获取失败：按4.2.2固定回退策略执行
- 云同步失败：仅提示不阻断本地保存（若启用）

---

## 4. 功能需求（FR）

### 4.1 交易流水（P0）

#### 4.1.1 类型

- 支出 expense
- 收入 income
- 转账 transfer（仅同币种账户间）
- 余额调整 adjustment（P1预留）

#### 4.1.2 新增/编辑/删除规则

- 金额：0 < amount ≤ 9,999,999.99
- 备注：0~200字符（超出提示并阻止保存）
- 时间：允许回溯至过去2年（MVP）
- 删除：MVP采用软删字段 `deleted_at`

**软删可见性与一致性（MVP硬规则）**

- 设置 `deleted_at` 后，**立即**从所有用户可见列表、搜索、报表、余额计算、预算计算中排除
- `deleted_at` 仅用于后台审计/未来恢复预留（MVP无回收站入口）

**验收**

- 新增：保存后1秒内列表出现；余额/预算进度刷新
- 编辑：修改后余额/报表/预算一致更新
- 删除：删除操作完成后立即不可见，余额/报表/预算即时回滚正确

#### 4.1.3 智能补全（MVP锁定）

- 数据集：同账本最近N=30条流水
- 匹配：简单前后包含匹配 + 忽略大小写（中文不分词）
- 触发：备注输入≥2字符
- 输出：Top1-3 chips（类别+账户），按最近使用+频次排序
- 已知局限：中文召回率有限（记录在版本说明中）

### 4.2 账户与多币种（P0）

#### 4.2.1 账户字段

name、type、currency、initial_balance（允许负）、is_hidden、include_in_total

#### 4.2.2 汇率快照（关键一致性规则）

- 账本级 `base_currency`（默认CNY）
- **账本创建后不允许修改 base_currency（MVP硬规则）**
- 每条交易保存：tx_currency、fx_rate_to_base、fx_source(api/manual)、fx_timestamp

**汇率缓存口径（滑动24h）**

- 从上次成功拉取时刻起24小时内有效

**汇率失败回退策略（MVP锁定）**

- 若无可用缓存时：
  - `fx_rate_to_base` **强制设为 1**（不折算）
  - `fx_source` = manual
  - 保存时弹出**模态Alert**（iOS UIAlertController / Android AlertDialog），文案：  
    **“汇率服务暂不可用，已使用1:1折算。请稍后联网手动刷新汇率。”**  
    用户必须点击“确认”或“稍后”才完成保存
- 历史报表一律使用交易快照折算；汇率刷新不影响历史结果
- fx_rate_to_base 默认不可编辑（P1才考虑更正入口）

### 4.3 转账（P0）

- 仅支持同币种账户间转账
- 跨币种转账禁止，提示：“暂不支持不同币种账户间转账”
- 转账不计入预算支出

### 4.4 账本与家庭协作（P0）

#### 4.4.1 账本类型

个人账本 / 家庭账本 / 隐私账本（进入需生物识别+PIN）

#### 4.4.2 角色与权限矩阵（MVP锁定）

| 能力           | Admin |    Member | Viewer |            Child |
| -------------- | ----: | --------: | -----: | ---------------: |
| 查看家庭汇总   |    ✅ |        ✅ |     ✅ |   ✅（仅总览卡） |
| 查看他人明细   |    ✅ |        ✅ |     ✅ |               ❌ |
| 新增流水       |    ✅ |        ✅ |     ❌ |   ✅（仅自己的） |
| 编辑自己的流水 |    ✅ |        ✅ |     ❌ |               ✅ |
| 编辑他人流水   |    ✅ |        ❌ |     ❌ |               ❌ |
| 删除自己的流水 |    ✅ |        ✅ |     ❌ | ✅（仅当日可删） |
| 删除他人流水   |    ✅ |        ❌ |     ❌ |               ❌ |
| 邀请/移除成员  |    ✅ |        ❌ |     ❌ |               ❌ |
| 设置预算       |    ✅ | ❌（MVP） |     ❌ |               ❌ |

**Child “当日可删”判定（MVP锁定）**

- `occurred_at` 以 **UTC** 存储
- 交易创建时额外记录 `occurred_local_date`（交易发生时设备本地时区的date part，如 "2025-02-21"）
- 删除权限判定：`occurred_local_date == 当前设备本地日期` 才允许Child删除

**儿童可见性规则（隐私优先）**

- Child只能看自己的明细 + 家庭总览卡
- 不显示成员排行、不显示他人明细/备注

### 4.5 预算与报表（P1，V1.0可轻量）

- 月度预算；仅统计支出expense；阈值默认90%/100%；App内通知中心+系统推送；去重同周期同阈值1次/天
- 报表：分类占比、趋势、预算进度；10,000条以内报表页P95<2秒

### 4.6 安全与隐私（P0）

- 本地加密数据库
- 隐私解锁：生物识别失败3次 **必须** 进入PIN验证（MVP必须实现自定义PIN）；无生物识别设备直接PIN输入框
- **MVP阶段隐私账本完全禁止任何导出/分享功能（无入口、无API暴露）**

### 4.7 云同步（P1，可选开关）

- 用户手动开启；增量同步；冲突LWW + last_modified_by
- **隐私账本强制不参与任何形式云同步（MVP硬规则）**
- **实现要求**：隐私账本相关表/字段在代码中硬编码过滤，不参与任何同步操作；上线前需代码审查Checklist确认。

### 5. Web端展示（MVP必须做）

- 仅展示/演示App效果：设备框 + 可点击演示流程 + 下载引导
- 不登录、不接真实用户数据、不请求账本后端
- 验收：首屏<3秒；演示流程可跑；无真实数据请求；下载跳转正确
